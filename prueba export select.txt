<!DOCTYPE html>
<html lang="en">
    <head>
        <?php require '../../css/TmplHead2.php'; ?>        
        <title>Actualizar Gestion Externa</title>
    </head>

    <body>

        <div id="wrapper">
            <?php require '../../css/TmplNabvar2.php'; ?>
            <div id="page-wrapper">
                <div class="row">
                    <div class="col-lg-12">
                        <br/>
                        <h1 class="page-header" align="center">Gestion Externa</h1>
                    </div>
                </div>
                <div class="row" align="center">
                    <div class="col-lg-12" style="font-size: 16px;">
                        <br/>
                        <p style="color: red; font-size: 20px;">NOTA: &nbsp;<a style="font-size: 17px; color: black;">Recuerde filtrar por el producto</a></p>
                        <br/><br/>
                        <form name="importa" action="../Update/UpdateGesExt.php" enctype="multipart/form-data" action="<?php echo $_SERVER['PHP_SELF']; ?>" method="post">
                            <table width="100%" class="table table-striped table-bordered table-hover" id="tablasExp" style="font-size: 16px;">
                                <thead align="center">
                                    <tr class="headers">
                                        <th style="text-align: center;">Producto</th>
                                        <th style="text-align: center;">Subir Archivos</th>
                                    </tr>
                                </thead>
                                <tbody align="center">                                
                                    <tr class="tables">
                                        <td style="font-size: 18px;">
                                            <select name="producto" class="form-control" style="width: 180px;">
                                                <option selected="" value="default">Seleccione Producto</option>
                                                <option value="CF">CF</option>
                                                <option value="CV">CV</option>
                                                <option value="CP">CP</option>
                                                <option value="C1">C1</option>
                                                <option value="TG">TG</option>
                                                <option value="TODOS">ALL</option>
                                            </select>
                                        </td>
                                        <td>                                        
                                            <input type="file" name="excel" style="display: inline-block;"/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                            <input type='submit' name='enviar' value="Importar" style="display: inline-block;"/>
                                            <input type="hidden" value="upload" name="action" />
                                        </td>
                                    </tr>                                
                                </tbody>
                            </table>
                        </form>
                        <br/><br/>
                        <?php
                        error_reporting(E_ALL);
                        ini_set('display_errors', TRUE);
                        ini_set('display_startup_errors', TRUE);
                        date_default_timezone_set('America/Bogota');
                        require_once '../../library/PHPExcel-1.8/Classes/PHPExcel.php';
                        require_once '../../library/PHPExcel-1.8/Classes/PHPExcel/Reader/Excel2007.php';
                        require '../../controller/Conexion.php';

                        $action = '';
                        extract($_POST);
                        if ($action == 'upload') {
                            $archivo = $_FILES['excel']['name'];
                            $tipo = $_FILES['excel']['type'];
                            $destino = "Arch_" . $archivo;
                            if (copy($_FILES['excel']['tmp_name'], $destino)) {
                                echo("<div class='alert alert-success' role='alert'><strong>Exito!</strong> Archivo cargado con exito.</div>");
                            } else {
                                echo "<div class='alert alert-danger' role='alert'><strong>Error!</strong> Error al cargar el archivo.</div>";
                            }
                            if (file_exists("Arch_" . $archivo)) {
                                $pro = $_POST["producto"];
                                $cn = $conexion;
                                $objReader = new PHPExcel_Reader_Excel2007();
                                $objPHPExcel = $objReader->load("Arch_" . $archivo);
                                $objFecha = new PHPExcel_Shared_Date();
                                $objPHPExcel->setActiveSheetIndex(0);
                                $i = 1;
                                $param = 0;
                                while ($param == 0) {
                                    $fr = $objPHPExcel->getActiveSheet()->getCell('A1' . $i)->getCalculatedValue();
                                    $fl = $objPHPExcel->getActiveSheet()->getCell('B1' . $i)->getCalculatedValue();
                                    $hgi = $objPHPExcel->getActiveSheet()->getCell('C1' . $i)->getCalculatedValue();
                                    $hgf = $objPHPExcel->getActiveSheet()->getCell('D1' . $i)->getCalculatedValue();
                                    $id = $objPHPExcel->getActiveSheet()->getCell('E1' . $i)->getCalculatedValue();
                                    $cr = $objPHPExcel->getActiveSheet()->getCell('F1' . $i)->getCalculatedValue();
                                    $npc = $objPHPExcel->getActiveSheet()->getCell('G1' . $i)->getCalculatedValue();
                                    $nm = $objPHPExcel->getActiveSheet()->getCell('H1' . $i)->getCalculatedValue();
                                    $t = $objPHPExcel->getActiveSheet()->getCell('I1' . $i)->getCalculatedValue();
                                    $rm = $objPHPExcel->getActiveSheet()->getCell('J1' . $i)->getCalculatedValue();
                                    $g = $objPHPExcel->getActiveSheet()->getCell('K1' . $i)->getCalculatedValue();
                                    $f = $objPHPExcel->getActiveSheet()->getCell('L1' . $i)->getCalculatedValue();
                                    $fp = $objPHPExcel->getActiveSheet()->getCell('M1' . $i)->getCalculatedValue();
                                    $vp = $objPHPExcel->getActiveSheet()->getCell('N1' . $i)->getCalculatedValue();
                                    $as = $objPHPExcel->getActiveSheet()->getCell('O1' . $i)->getCalculatedValue();
                                    $ma = $objPHPExcel->getActiveSheet()->getCell('P1' . $i)->getCalculatedValue();
                                    $ag = $objPHPExcel->getActiveSheet()->getCell('Q1' . $i)->getCalculatedValue();
                                    $p = $objPHPExcel->getActiveSheet()->getCell('R1' . $i)->getCalculatedValue();
                                    $tg = $objPHPExcel->getActiveSheet()->getCell('S1' . $i)->getCalculatedValue();
                                    switch ($pro) {
                                        case 'default':
                                            echo "<div class='alert alert-danger' role='alert'><strong>Error!</strong> Seleccione un producto.</div>";
                                            break;
                                        case 'CF':
                                            $c1 = ("INSERT INTO `gestion externa`(Fecha Reporte, Fecha Llamada, Hora Gestion Inicial, Hora Gestion Final, Identificacion, 
                        Credito, N° Producto/Credito, Numero Marcado, Tipificacion, Razon Mora, Gestion, Franja, Fecha de Promesa, Valor Promesa, 
                        Asesor, Mes Asignado, Agencia, Producto, Tipo Gestion) VALUES ('$fr','$fl','$hgi','$hgf','$id','$cr','$npc','$nm','$t','$rm','$g',"
                                                    . "'$f','$fp','$vp','$as','$ma','$ag','$p','$tg') WHERE Producto = 'CF'");
                                            mysqli_query($cn, $c1);
                                            break;
                                        case 'CV':
                                            $c2 = ("INSERT INTO `gestion externa`(Fecha Reporte, Fecha Llamada, Hora Gestion Inicial, Hora Gestion Final, Identificacion, 
                        Credito, N° Producto/Credito, Numero Marcado, Tipificacion, Razon Mora, Gestion, Franja, Fecha de Promesa, Valor Promesa, 
                        Asesor, Mes Asignado, Agencia, Producto, Tipo Gestion) VALUES ('$fr','$fl','$hgi','$hgf','$id','$cr','$npc','$nm','$t','$rm','$g',"
                                                    . "'$f','$fp','$vp','$as','$ma','$ag','$p','$tg') WHERE Producto = 'CV'");
                                            mysqli_query($cn, $c2);
                                            break;
                                        case 'CP':
                                            $c3 = ("INSERT INTO `gestion externa`(Fecha Reporte, Fecha Llamada, Hora Gestion Inicial, Hora Gestion Final, Identificacion, 
                        Credito, N° Producto/Credito, Numero Marcado, Tipificacion, Razon Mora, Gestion, Franja, Fecha de Promesa, Valor Promesa, 
                        Asesor, Mes Asignado, Agencia, Producto, Tipo Gestion) VALUES ('$fr','$fl','$hgi','$hgf','$id','$cr','$npc','$nm','$t','$rm','$g',"
                                                    . "'$f','$fp','$vp','$as','$ma','$ag','$p','$tg') WHERE Producto = 'CP'");
                                            mysqli_query($cn, $c3);
                                            break;
                                        case 'C1':
                                            $c4 = ("INSERT INTO `gestion externa`(Fecha Reporte, Fecha Llamada, Hora Gestion Inicial, Hora Gestion Final, Identificacion, 
                        Credito, N° Producto/Credito, Numero Marcado, Tipificacion, Razon Mora, Gestion, Franja, Fecha de Promesa, Valor Promesa, 
                        Asesor, Mes Asignado, Agencia, Producto, Tipo Gestion) VALUES ('$fr','$fl','$hgi','$hgf','$id','$cr','$npc','$nm','$t','$rm','$g',"
                                                    . "'$f','$fp','$vp','$as','$ma','$ag','$p','$tg') WHERE Producto = 'C1'");
                                            mysqli_query($cn, $c4);
                                            break;
                                        case 'TG':
                                            $c5 = ("INSERT INTO `gestion externa`(Fecha Reporte, Fecha Llamada, Hora Gestion Inicial, Hora Gestion Final, Identificacion, 
                        Credito, N° Producto/Credito, Numero Marcado, Tipificacion, Razon Mora, Gestion, Franja, Fecha de Promesa, Valor Promesa, 
                        Asesor, Mes Asignado, Agencia, Producto, Tipo Gestion) VALUES ('$fr','$fl','$hgi','$hgf','$id','$cr','$npc','$nm','$t','$rm','$g',"
                                                    . "'$f','$fp','$vp','$as','$ma','$ag','$p','$tg') WHERE Producto = 'TC'");
                                            mysqli_query($cn, $c5);
                                            break;
                                        case 'TODOS':
                                            $c6 = ("INSERT INTO `gestion externa`(Fecha Reporte, Fecha Llamada, Hora Gestion Inicial, Hora Gestion Final, Identificacion, 
                        Credito, N° Producto/Credito, Numero Marcado, Tipificacion, Razon Mora, Gestion, Franja, Fecha de Promesa, Valor Promesa, 
                        Asesor, Mes Asignado, Agencia, Producto, Tipo Gestion) VALUES ('$fr','$fl','$hgi','$hgf','$id','$cr','$npc','$nm','$t','$rm','$g',"
                                                    . "'$f','$fp','$vp','$as','$ma','$ag','$p','$tg')");
                                            mysqli_query($cn, $c6);
                                            break;
                                        default:
                                    }
                                    if ($objPHPExcel->getActiveSheet()->getCell('A' . $i)->getCalculatedValue() == NULL) {
                                        $param = 1;
                                    }
                                    $i++;
                                }
                                echo "";
                            } else {
                                echo "<div class='alert alert-danger' role='alert'><strong>Error!</strong> Necesitas primero importar el archivo.</div>";
                            }
                            unlink($destino);

                            $filas = $objPHPExcel->setActiveSheetIndex(0)->getHighestRow();
                            $columnas = $objPHPExcel->setActiveSheetIndex(0)->getHighestColumn();
                            $filas = $objPHPExcel->setActiveSheetIndex(0)->getHighestRow();
                            echo 'getHighestColumn() =  [' . $columnas . ']<br/>';
                            echo 'getHighestRow() =  [' . $filas . ']<br/>';
                            echo '<table border="1">';
                            echo $count = 0;
                            foreach ($objPHPExcel->setActiveSheetIndex(0)->getRowIterator() as $row) {
                                $count++;
                                $cellIterator = $row->getCellIterator();
                                $cellIterator->setIterateOnlyExistingCells(false);
                                echo '<tr>';
                                foreach ($cellIterator as $cell) {
                                    if (!is_null($cell)) {
                                        $value = $cell->getCalculatedValue();
                                        echo '<td>';
                                        echo $value . ' ';
                                        echo '</td>';
                                    }
                                }
                                echo '</tr>';
                            }
                        }
                        ?>
                    </div>                    
                </div>
            </div>
        </div>       
    </body>
</html>
